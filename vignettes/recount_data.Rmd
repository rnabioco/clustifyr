---
title: 'Downloading data from recount'
date: '`r Sys.Date()`'
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
    vignette: >
      %\VignetteIndexEntry{rclusterct-get_data}
      %\VignetteEngine{knitr::rmarkdown}
      %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```
## Preprocessing data from the recount database

Here we will download a [study](https://trace.ncbi.nlm.nih.gov/Traces/sra/?study=SRP051688) of human vaccination responses in which individual cell types were sorted out from PBMCs. 
```{r}
library('recount')
library('biomaRt')
library('dplyr')
library('purrr')
library('stringr')
```

Download the `rse_gene.Rdata` file which contains per gene counts of all the samples in the GEO record. 

```{r}
download_study("SRP051688")
load(file.path("SRP051688", "rse_gene.Rdata"))
rse_gene

# no longer need to downloaded data
unlink("SRP051688", recursive = TRUE)
```


By default the counts are stored as basepair coverage. To convert to read counts use the `scale_counts()` function. 

```{r}
## covert to read counts
rse <- scale_counts(rse_gene)
read_counts <- assay(rse, "counts")

read_counts[1:5, 1:5]
```

The metadata is stored in the `colData(rse_gene)` slot. 

```{r}
mdata <- as.data.frame(colData(rse_gene)) 
mdata <- mutate(mdata, tpt = purrr::map_chr(characteristics, ~.x[1]))
mdata <- mutate(mdata, cell_type = purrr::map_chr(characteristics, ~.x[2]))

mdata[1:10, 1:10]
```

Next extract out the time point zero samples (not treated controls).
```{r}
tpt_zero <- filter(mdata, str_detect(tpt, "0"))

tpt_zero_mdata <- select(tpt_zero, run, tpt, cell_type)

tpt_zero_counts <- read_counts[, tpt_zero$run]
```

Lastly, we'll convert the ensembl ids into gene symbols, which are more commonly found in public data.
```{r}
gene_ids <- rownames(tpt_zero_counts)

ensembl = useMart("ensembl",dataset = "hsapiens_gene_ensembl")

gene_id_2_symbol <- getBM(attributes=c('ensembl_gene_id', 
                                       'ensembl_gene_id_version',
                                       'hgnc_symbol'),
      mart = ensembl)

gene2symbol <- gene_id_2_symbol %>% 
  filter(ensembl_gene_id_version %in% gene_ids) 

out_df <- tpt_zero_counts %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column("gene_id") %>% 
    left_join(., gene2symbol, by = c("gene_id" = "ensembl_gene_id_version")) %>% 
    dplyr::select(-gene_id, -ensembl_gene_id) %>% 
    dplyr::select(hgnc_symbol, everything()) %>% 
    filter(!is.na(hgnc_symbol)) %>% 
    filter(hgnc_symbol != "")

pbmc_bulk_matrix <- tidyr::gather(out_df, library, expr, -hgnc_symbol) %>% 
  group_by(hgnc_symbol, library) %>% 
  summarize(expr = sum(expr)) %>% 
  tidyr::spread(library, expr) %>% 
  as.data.frame() %>% 
  tibble::column_to_rownames("hgnc_symbol") %>% 
  as.matrix()
   
new_ids <- left_join(data_frame(run = colnames(pbmc_bulk_matrix)), 
          tpt_zero_mdata) %>% 
  mutate(cell_type = stringr::str_replace(cell_type, "cell type: ", "")) %>% 
  group_by(cell_type) %>% 
  mutate(cell_id = stringr::str_c(cell_type, " rep ", row_number())) %>% 
  pull(cell_id)

colnames(pbmc_bulk_matrix) <- new_ids

pbmc_bulk_matrix[1:10, 1:10]
```


